<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><script>!function(){try{var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem("theme");if(e){d.add(e)}else{d.add('dark');}}catch(t){}}();</script><title>Self-Hosted Sentry: iOS system frames de-symbolication - Mike Gerasymenko</title><meta content="How to set up self-hosted Sentry for system frames de-symbolication on iOS." name="description"/><meta property="og:url" content="https://nextjs-typescript-mdx-blog.vercel.app/posts/self-hosted-sentry-smybols"/><link rel="canonical" href="https://nextjs-typescript-mdx-blog.vercel.app/posts/self-hosted-sentry-smybols"/><meta property="og:type" content="article"/><meta property="og:site_name" content="Mike Gerasymenko - iOS et al."/><meta property="og:description" content="How to set up self-hosted Sentry for system frames de-symbolication on iOS."/><meta property="og:title" content="Self-Hosted Sentry: iOS system frames de-symbolication - Mike Gerasymenko"/><meta property="og:image" content="https://nextjs-typescript-mdx-blog.vercel.app/images/sentry-symbols/sentry.svg"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@huntarosan"/><meta name="twitter:title" content="Self-Hosted Sentry: iOS system frames de-symbolication - Mike Gerasymenko"/><meta name="twitter:description" content="How to set up self-hosted Sentry for system frames de-symbolication on iOS."/><meta name="twitter:image" content="https://nextjs-typescript-mdx-blog.vercel.app/images/sentry-symbols/sentry.svg"/><meta property="article:published_time" content="2023-04-03"/><link rel="preload" as="image" imagesrcset="/images/sentry-symbols/sentry.svg?auto=format&amp;fit=max&amp;w=750 1x, /images/sentry-symbols/sentry.svg?auto=format&amp;fit=max&amp;w=1920 2x"/><link rel="preload" as="image" imagesrcset="/images/sentry-symbols/not-symbolicated.png?auto=format&amp;fit=max&amp;w=1920 1x, /images/sentry-symbols/not-symbolicated.png?auto=format&amp;fit=max&amp;w=3840 2x"/><link rel="preload" as="image" imagesrcset="/images/sentry-symbols/download.png?auto=format&amp;fit=max&amp;w=640 1x, /images/sentry-symbols/download.png?auto=format&amp;fit=max&amp;w=1080 2x"/><link rel="preload" as="image" imagesrcset="/images/sentry-symbols/brrr.png?auto=format&amp;fit=max&amp;w=384 1x, /images/sentry-symbols/brrr.png?auto=format&amp;fit=max&amp;w=640 2x"/><link rel="preload" as="image" imagesrcset="/images/sentry-symbols/configuration.png?auto=format&amp;fit=max&amp;w=1920 1x, /images/sentry-symbols/configuration.png?auto=format&amp;fit=max&amp;w=3840 2x"/><link rel="preload" as="image" imagesrcset="/images/sentry-symbols/voila.png?auto=format&amp;fit=max&amp;w=1920 1x, /images/sentry-symbols/voila.png?auto=format&amp;fit=max&amp;w=3840 2x"/><meta name="next-head-count" content="24"/><link rel="preload" href="/_next/static/css/3c344473ae44fdd81992.css" as="style"/><link rel="stylesheet" href="/_next/static/css/3c344473ae44fdd81992.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-61095c13c5984b221292.js" defer=""></script><script src="/_next/static/chunks/framework-92300432a1172ef1338b.js" defer=""></script><script src="/_next/static/chunks/main-696b585dd874563fe98f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ee6fc650a19b3cc42291.js" defer=""></script><script src="/_next/static/chunks/466-0c3cbe99aa1f071cd23c.js" defer=""></script><script src="/_next/static/chunks/522-2597210efd9529a81949.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-5f95380ee98e6c7e8b61.js" defer=""></script><script src="/_next/static/JzhBuRdGGKtUlqmGbVtnu/_buildManifest.js" defer=""></script><script src="/_next/static/JzhBuRdGGKtUlqmGbVtnu/_ssgManifest.js" defer=""></script></head><body class="bg-white dark:bg-black text-gray-900 dark:text-white"><div id="__next"><header><div class="max-w-5xl px-8 mx-auto"><div class="flex items-center justify-between py-6"><nav><a class="text-gray-900 dark:text-white pr-6 py-4" href="/">Home</a><a class="text-gray-900 dark:text-white px-6 py-4" href="/about">About</a></nav></div></div></header><main><div class="max-w-5xl px-8 py-4 mx-auto"><article><h1 class="mb-3 text-gray-900 dark:text-white">Self-Hosted Sentry: iOS system frames de-symbolication</h1><p class="mb-10 text-sm text-gray-500 dark:text-gray-400">April 03, 2023</p><div class="prose dark:prose-dark"><div style="display:inline-block;max-width:100%;overflow:hidden;position:relative;box-sizing:border-box;margin:0"><div style="box-sizing:border-box;display:block;max-width:100%"><img style="max-width:100%;display:block;margin:0;border:none;padding:0" alt="" aria-hidden="true" role="presentation" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzIwIiBoZWlnaHQ9IjU0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiLz4="/></div><img alt="Sentry" srcSet="/images/sentry-symbols/sentry.svg?auto=format&amp;fit=max&amp;w=750 1x, /images/sentry-symbols/sentry.svg?auto=format&amp;fit=max&amp;w=1920 2x" src="/images/sentry-symbols/sentry.svg?auto=format&amp;fit=max&amp;w=1920" decoding="async" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/></div><h3 id="introduction"><a aria-hidden="true" tabindex="-1" href="#introduction"><span class="icon icon-link"></span></a>Introduction</h3><p>Sentry is an application performance and error tracking tool. It is available as a SaaS product and can be self-hosted. Sentry can be used to track errors and crashes in mobile applications. Sentry can also be used to track performance metrics such as memory usage, CPU usage, and network usage.</p><p>In this article, we will go through the steps required to set up a self-hosted Sentry for system frames de-symbolication on iOS. </p><p>People use self-hosted Sentry to have it fine tuned for their needs and to have more control over the data. Additionally, it can be cheaper to run self-hosted Sentry than to use the SaaS product.</p><p>Cloud-based Sentry has the system symbols available for de-symbolication. However, self-hosted Sentry does not have the system symbols available. This article will show you how to set up self-hosted Sentry to de-symbolicate the system frames.</p><p>This core building block is in my opinion required for any self-hosted Sentry instance. It allows you to see the method names of the system frameworks in your stack traces.</p><p>Default self-hosted Sentry allows you to de-symbolicate the frames in the application code. However, it does not allow you to de-symbolicate the frames in the system frameworks. This is because the system frameworks are not part of the application bundle. They are part of the operating system, and they are different for different operating system releases.</p><h3 id="prerequisites"><a aria-hidden="true" tabindex="-1" href="#prerequisites"><span class="icon icon-link"></span></a>Prerequisites</h3><ul><li>Running self-hosted Sentry instance</li><li>S3 bucket to store the de-symbolication information</li></ul><h3 id="what-is-de-symbolication"><a aria-hidden="true" tabindex="-1" href="#what-is-de-symbolication"><span class="icon icon-link"></span></a>What is de-symbolication</h3><p>When an application is crashing, the operating system collects the stack trace of the crash. The stack trace contains the addresses of the methods that were executed when the crash happened. The stack trace is then sent to Sentry. Sentry then tries to de-symbolicate the stack trace. De-symbolication is the process of converting the addresses to method names. This allows you to see the method names in the stack trace.</p><p>For your application, Xcode is creating a mapping file that maps the addresses to the method names. This mapping file is then uploaded to Sentry. When Sentry receives a crash report, it uses the mapping file to de-symbolicate the stack trace.</p><p>For the system frameworks, there is no mapping file. The system frameworks are part of the operating system.</p><div style="display:inline-block;max-width:100%;overflow:hidden;position:relative;box-sizing:border-box;margin:0"><div style="box-sizing:border-box;display:block;max-width:100%"><img style="max-width:100%;display:block;margin:0;border:none;padding:0" alt="" aria-hidden="true" role="presentation" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQwNCIgaGVpZ2h0PSIxOTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmVyc2lvbj0iMS4xIi8+"/></div><img alt="Symbolicated crash: symbols for UIKit are missing" srcSet="/images/sentry-symbols/not-symbolicated.png?auto=format&amp;fit=max&amp;w=1920 1x, /images/sentry-symbols/not-symbolicated.png?auto=format&amp;fit=max&amp;w=3840 2x" src="/images/sentry-symbols/not-symbolicated.png?auto=format&amp;fit=max&amp;w=3840" decoding="async" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/></div><h3 id="how-sentry-is-de-symbolicating-crashes"><a aria-hidden="true" tabindex="-1" href="#how-sentry-is-de-symbolicating-crashes"><span class="icon icon-link"></span></a>How Sentry is de-symbolicating crashes</h3><p>Sentry is using a special service called <a href="https://github.com/getsentry/symbolicator">Symbolicator</a> to de-symbolicate the stack traces. Symbolicator is a standalone service that can be run independently from Sentry. It is also possible to run Symbolicator as a part of Sentry. In this article, we will be running Symbolicator as a part of Sentry.</p><h2 id="setting-it-up"><a aria-hidden="true" tabindex="-1" href="#setting-it-up"><span class="icon icon-link"></span></a>Setting it up</h2><h3 id="procuring-the-system-frameworks"><a aria-hidden="true" tabindex="-1" href="#procuring-the-system-frameworks"><span class="icon icon-link"></span></a>Procuring the system frameworks</h3><p>I could not find any official way to download the system frameworks. It is possible to acquire them using Xcode. If you connect a device running a certain iOS version to your computer, Xcode is going to fetch the system frameworks to your machine (in <code>/Library/Developer/Xcode/iOS\ DeviceSupport</code>). However, I found a <a href="https://github.com/CXTretar/iOS-System-Symbols-Supplement">GitHub repository</a> that contains the system frameworks for iOS 12. I downloaded the repository and extracted the system frameworks from it.</p><p>I am unaware of the licensing implications of copying the system symbols, but I think it is fine unless you are not distributing them. I hope eventually there would be a public repository that engineers could access.</p><div style="display:inline-block;max-width:100%;overflow:hidden;position:relative;box-sizing:border-box;margin:0"><div style="box-sizing:border-box;display:block;max-width:100%"><img style="max-width:100%;display:block;margin:0;border:none;padding:0" alt="" aria-hidden="true" role="presentation" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTA2IiBoZWlnaHQ9IjU1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiLz4="/></div><img alt="A lot of archived symbols downloading" srcSet="/images/sentry-symbols/download.png?auto=format&amp;fit=max&amp;w=640 1x, /images/sentry-symbols/download.png?auto=format&amp;fit=max&amp;w=1080 2x" src="/images/sentry-symbols/download.png?auto=format&amp;fit=max&amp;w=1080" decoding="async" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/></div><p>The total size of all symbols for iOS 12 to iOS 16.3 is about 60 gigabytes, so you might need to empty your Derived Data folder before downloading and unarchiving them.</p><h3 id="sorting-symbols-to-a-unified-format"><a aria-hidden="true" tabindex="-1" href="#sorting-symbols-to-a-unified-format"><span class="icon icon-link"></span></a>Sorting symbols to a unified format</h3><p>Sentry created a special tool to sort existing OS-provided symbol information into a unified format. This tool is called <a href="https://github.com/getsentry/symbolicator/tree/master/crates/symsorter">symsorter</a>. It is a Rust binary that can be compiled and run on your machine. </p><h4 id="building-sorter"><a aria-hidden="true" tabindex="-1" href="#building-sorter"><span class="icon icon-link"></span></a>Building Sorter</h4><p>You need to have Rust installed on your machine. You can install Rust using <a href="https://brew.sh">homebrew</a>:</p><pre class="language-bash"><code class="language-bash">brew <span class="token function">install</span> rust
</code></pre><p>Then you need to check out the symbolicator repository:</p><pre class="language-bash"><code class="language-bash"><span class="token function">git</span> clone git@github.com:getsentry/symbolicator.git
</code></pre><p>Once you have Rust installed, you can build the symsorter binary by running the following command:</p><pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">cd</span> symbolicator/crates/symsorter
cargo build --release
</code></pre><p>This will create a binary in <code>symbolicator/target/release/symsorter</code>. You can copy it to your path or run it from the current directory.</p><h3 id="sorting"><a aria-hidden="true" tabindex="-1" href="#sorting"><span class="icon icon-link"></span></a>Sorting</h3><p>In order to sort symbols, you need to create an empty folder on your local machine, for example <code>~/ios_symbols</code>.</p><p>Then you need to run the following command:</p><pre class="language-bash"><code class="language-bash">symbolicator/target/release/symsorter -zz -o ~/ios_symbols --prefix ios --bundle-id <span class="token number">16.3</span>.1-arm64e ~/Downloads/16.3.1<span class="token punctuation">\</span> <span class="token punctuation">\</span><span class="token punctuation">(</span>20D67<span class="token punctuation">\</span><span class="token punctuation">)</span><span class="token punctuation">\</span> arm64e
</code></pre><p>You need to run it for every symbol file you have. In my case, I have a whopping 129 symbol files. I have created a bash script to run the command for every symbol file:</p><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token function">find</span> <span class="token builtin class-name">.</span> -type d -maxdepth <span class="token number">1</span> -print0 <span class="token operator">|</span> <span class="token keyword">while</span> <span class="token builtin class-name">read</span> -d $<span class="token string">&#x27;<span class="token entity" title="\0">\0</span>&#x27;</span> <span class="token function">file</span>
<span class="token keyword">do</span>
 <span class="token builtin class-name">echo</span> <span class="token string">&quot;Processing <span class="token variable">$file</span>&quot;</span>
 <span class="token assign-left variable">path</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">echo</span> $file <span class="token operator">|</span> <span class="token function">sed</span> -E <span class="token string">&#x27;s/^\.\/([0-9\.]*) \(([A-Z0-9]*)\) ?(arm64.)?/<span class="token entity" title="\1">\1</span>-<span class="token entity" title="\2">\2</span>-<span class="token entity" title="\3">\3</span>/&#x27;</span><span class="token variable">`</span></span>
 <span class="token builtin class-name">echo</span> <span class="token string">&quot;path: <span class="token variable">$path</span>&quot;</span>

 <span class="token punctuation">..</span>/symbolicator/target/release/symsorter -zz -o <span class="token punctuation">..</span>/sorted_symbols --prefix ios --bundle-id <span class="token string">&quot;<span class="token variable">$path</span>&quot;</span> <span class="token string">&quot;<span class="token variable">$file</span>&quot;</span>
<span class="token keyword">done</span>
</code></pre><p>You run this script in the folder where you have extracted the system frameworks. It will create a folder called <code>sorted_symbols</code> with the sorted symbols. This would take a while, and your CPU would do Brrr.</p><div style="display:inline-block;max-width:100%;overflow:hidden;position:relative;box-sizing:border-box;margin:0"><div style="box-sizing:border-box;display:block;max-width:100%"><img style="max-width:100%;display:block;margin:0;border:none;padding:0" alt="" aria-hidden="true" role="presentation" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjY5IiBoZWlnaHQ9IjQ2NyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiLz4="/></div><img alt="CPU load using symbolicator: Brrrr" srcSet="/images/sentry-symbols/brrr.png?auto=format&amp;fit=max&amp;w=384 1x, /images/sentry-symbols/brrr.png?auto=format&amp;fit=max&amp;w=640 2x" src="/images/sentry-symbols/brrr.png?auto=format&amp;fit=max&amp;w=640" decoding="async" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/></div><h3 id="uploading-symbols-to-s3"><a aria-hidden="true" tabindex="-1" href="#uploading-symbols-to-s3"><span class="icon icon-link"></span></a>Uploading symbols to S3</h3><p>As mentioned above, you need to provide an S3 bucket to host the sorted symbols. You can create an S3 bucket using the AWS console.</p><p>Then you need to upload the sorted symbols to the S3 bucket. You can use the AWS console or the AWS CLI. I have used the AWS CLI to upload the symbols:</p><pre class="language-bash"><code class="language-bash">aws s3 <span class="token function">sync</span> <span class="token punctuation">..</span>/sorted_symbols s3://sentry-symbols/
</code></pre><h3 id="configuring-sentry-to-use-the-symbols"><a aria-hidden="true" tabindex="-1" href="#configuring-sentry-to-use-the-symbols"><span class="icon icon-link"></span></a>Configuring Sentry to use the symbols</h3><p>In order to configure yout Sentry instance to use the symbols you need to open your project preferences (open your project -&gt; Cogwheel on the right) and go to the Processing -&gt; Debug Files section.</p><p>Then in Custom repositories select &quot;Add Repository&quot; and enter the needed information:</p><div style="display:inline-block;max-width:100%;overflow:hidden;position:relative;box-sizing:border-box;margin:0"><div style="box-sizing:border-box;display:block;max-width:100%"><img style="max-width:100%;display:block;margin:0;border:none;padding:0" alt="" aria-hidden="true" role="presentation" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTM1NCIgaGVpZ2h0PSIyMDEwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIvPg=="/></div><img alt="Configuration" srcSet="/images/sentry-symbols/configuration.png?auto=format&amp;fit=max&amp;w=1920 1x, /images/sentry-symbols/configuration.png?auto=format&amp;fit=max&amp;w=3840 2x" src="/images/sentry-symbols/configuration.png?auto=format&amp;fit=max&amp;w=3840" decoding="async" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/></div><h2 id="conclusion"><a aria-hidden="true" tabindex="-1" href="#conclusion"><span class="icon icon-link"></span></a>Conclusion</h2><div style="display:inline-block;max-width:100%;overflow:hidden;position:relative;box-sizing:border-box;margin:0"><div style="box-sizing:border-box;display:block;max-width:100%"><img style="max-width:100%;display:block;margin:0;border:none;padding:0" alt="" aria-hidden="true" role="presentation" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTM0NiIgaGVpZ2h0PSIyNDQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmVyc2lvbj0iMS4xIi8+"/></div><img alt="Voila" srcSet="/images/sentry-symbols/voila.png?auto=format&amp;fit=max&amp;w=1920 1x, /images/sentry-symbols/voila.png?auto=format&amp;fit=max&amp;w=3840 2x" src="/images/sentry-symbols/voila.png?auto=format&amp;fit=max&amp;w=3840" decoding="async" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/></div><p>Nice, now you can see the method names of the system frameworks in your stack traces. This is a great step towards better crash reports. </p><p>NB: As Apple is going to release new iOS versions going forward, there would be a need to add new symbols to the S3 bucket. I am not sure how to automate this process, but I am sure it is possible. Most of the time it would be possible to collect the new symbols by updating your phone to the latest iOS version and connecting it to Xcode.</p><p>I hope this article was helpful. If you have any questions, feel free to reach out to me on Twitter: <a href="https://twitter.com/gk0io">@gk0io</a>.</p></div></article></div></main><footer class="py-8"><div class="max-w-5xl px-8 mx-auto">Created by <a href="https://github.com/mikeger">Mike Gerasymenko</a> ©<!-- --> <!-- -->2023<!-- --> All rights reserved.</div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"source":{"compiledSource":"var l=Object.defineProperty,d=Object.defineProperties;var h=Object.getOwnPropertyDescriptors;var o=Object.getOwnPropertySymbols;var r=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable;var p=(a,t,s)=\u003et in a?l(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s,e=(a,t)=\u003e{for(var s in t||(t={}))r.call(t,s)\u0026\u0026p(a,s,t[s]);if(o)for(var s of o(t))i.call(t,s)\u0026\u0026p(a,s,t[s]);return a},c=(a,t)=\u003ed(a,h(t));var m=(a,t)=\u003e{var s={};for(var n in a)r.call(a,n)\u0026\u0026t.indexOf(n)\u003c0\u0026\u0026(s[n]=a[n]);if(a!=null\u0026\u0026o)for(var n of o(a))t.indexOf(n)\u003c0\u0026\u0026i.call(a,n)\u0026\u0026(s[n]=a[n]);return s};const makeShortcode=a=\u003efunction(s){return console.warn(\"Component \"+a+\" was not imported, exported, or provided by MDXProvider as global scope\"),mdx(\"div\",e({},s))},Image=makeShortcode(\"Image\"),layoutProps={},MDXLayout=\"wrapper\";function MDXContent(s){var n=s,{components:a}=n,t=m(n,[\"components\"]);return mdx(MDXLayout,c(e(e({},layoutProps),t),{components:a,mdxType:\"MDXLayout\"}),mdx(Image,{alt:\"Sentry\",src:\"/images/sentry-symbols/sentry.svg\",width:720,height:540,priority:!0,mdxType:\"Image\"}),mdx(\"h3\",e({},{id:\"introduction\"}),mdx(\"a\",e({parentName:\"h3\"},{\"aria-hidden\":\"true\",tabIndex:-1,href:\"#introduction\"}),mdx(\"span\",e({parentName:\"a\"},{className:\"icon icon-link\"}))),\"Introduction\"),mdx(\"p\",null,\"Sentry is an application performance and error tracking tool. It is available as a SaaS product and can be self-hosted. Sentry can be used to track errors and crashes in mobile applications. Sentry can also be used to track performance metrics such as memory usage, CPU usage, and network usage.\"),mdx(\"p\",null,\"In this article, we will go through the steps required to set up a self-hosted Sentry for system frames de-symbolication on iOS. \"),mdx(\"p\",null,\"People use self-hosted Sentry to have it fine tuned for their needs and to have more control over the data. Additionally, it can be cheaper to run self-hosted Sentry than to use the SaaS product.\"),mdx(\"p\",null,\"Cloud-based Sentry has the system symbols available for de-symbolication. However, self-hosted Sentry does not have the system symbols available. This article will show you how to set up self-hosted Sentry to de-symbolicate the system frames.\"),mdx(\"p\",null,\"This core building block is in my opinion required for any self-hosted Sentry instance. It allows you to see the method names of the system frameworks in your stack traces.\"),mdx(\"p\",null,\"Default self-hosted Sentry allows you to de-symbolicate the frames in the application code. However, it does not allow you to de-symbolicate the frames in the system frameworks. This is because the system frameworks are not part of the application bundle. They are part of the operating system, and they are different for different operating system releases.\"),mdx(\"h3\",e({},{id:\"prerequisites\"}),mdx(\"a\",e({parentName:\"h3\"},{\"aria-hidden\":\"true\",tabIndex:-1,href:\"#prerequisites\"}),mdx(\"span\",e({parentName:\"a\"},{className:\"icon icon-link\"}))),\"Prerequisites\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"Running self-hosted Sentry instance\"),mdx(\"li\",{parentName:\"ul\"},\"S3 bucket to store the de-symbolication information\")),mdx(\"h3\",e({},{id:\"what-is-de-symbolication\"}),mdx(\"a\",e({parentName:\"h3\"},{\"aria-hidden\":\"true\",tabIndex:-1,href:\"#what-is-de-symbolication\"}),mdx(\"span\",e({parentName:\"a\"},{className:\"icon icon-link\"}))),\"What is de-symbolication\"),mdx(\"p\",null,\"When an application is crashing, the operating system collects the stack trace of the crash. The stack trace contains the addresses of the methods that were executed when the crash happened. The stack trace is then sent to Sentry. Sentry then tries to de-symbolicate the stack trace. De-symbolication is the process of converting the addresses to method names. This allows you to see the method names in the stack trace.\"),mdx(\"p\",null,\"For your application, Xcode is creating a mapping file that maps the addresses to the method names. This mapping file is then uploaded to Sentry. When Sentry receives a crash report, it uses the mapping file to de-symbolicate the stack trace.\"),mdx(\"p\",null,\"For the system frameworks, there is no mapping file. The system frameworks are part of the operating system.\"),mdx(Image,{alt:\"Symbolicated crash: symbols for UIKit are missing\",src:\"/images/sentry-symbols/not-symbolicated.png\",width:1404,height:196,priority:!0,mdxType:\"Image\"}),mdx(\"h3\",e({},{id:\"how-sentry-is-de-symbolicating-crashes\"}),mdx(\"a\",e({parentName:\"h3\"},{\"aria-hidden\":\"true\",tabIndex:-1,href:\"#how-sentry-is-de-symbolicating-crashes\"}),mdx(\"span\",e({parentName:\"a\"},{className:\"icon icon-link\"}))),\"How Sentry is de-symbolicating crashes\"),mdx(\"p\",null,\"Sentry is using a special service called \",mdx(\"a\",e({parentName:\"p\"},{href:\"https://github.com/getsentry/symbolicator\"}),\"Symbolicator\"),\" to de-symbolicate the stack traces. Symbolicator is a standalone service that can be run independently from Sentry. It is also possible to run Symbolicator as a part of Sentry. In this article, we will be running Symbolicator as a part of Sentry.\"),mdx(\"h2\",e({},{id:\"setting-it-up\"}),mdx(\"a\",e({parentName:\"h2\"},{\"aria-hidden\":\"true\",tabIndex:-1,href:\"#setting-it-up\"}),mdx(\"span\",e({parentName:\"a\"},{className:\"icon icon-link\"}))),\"Setting it up\"),mdx(\"h3\",e({},{id:\"procuring-the-system-frameworks\"}),mdx(\"a\",e({parentName:\"h3\"},{\"aria-hidden\":\"true\",tabIndex:-1,href:\"#procuring-the-system-frameworks\"}),mdx(\"span\",e({parentName:\"a\"},{className:\"icon icon-link\"}))),\"Procuring the system frameworks\"),mdx(\"p\",null,\"I could not find any official way to download the system frameworks. It is possible to acquire them using Xcode. If you connect a device running a certain iOS version to your computer, Xcode is going to fetch the system frameworks to your machine (in \",mdx(\"inlineCode\",{parentName:\"p\"},\"/Library/Developer/Xcode/iOS\\\\ DeviceSupport\"),\"). However, I found a \",mdx(\"a\",e({parentName:\"p\"},{href:\"https://github.com/CXTretar/iOS-System-Symbols-Supplement\"}),\"GitHub repository\"),\" that contains the system frameworks for iOS 12. I downloaded the repository and extracted the system frameworks from it.\"),mdx(\"p\",null,\"I am unaware of the licensing implications of copying the system symbols, but I think it is fine unless you are not distributing them. I hope eventually there would be a public repository that engineers could access.\"),mdx(Image,{alt:\"A lot of archived symbols downloading\",src:\"/images/sentry-symbols/download.png\",width:506,height:556,priority:!0,mdxType:\"Image\"}),mdx(\"p\",null,\"The total size of all symbols for iOS 12 to iOS 16.3 is about 60 gigabytes, so you might need to empty your Derived Data folder before downloading and unarchiving them.\"),mdx(\"h3\",e({},{id:\"sorting-symbols-to-a-unified-format\"}),mdx(\"a\",e({parentName:\"h3\"},{\"aria-hidden\":\"true\",tabIndex:-1,href:\"#sorting-symbols-to-a-unified-format\"}),mdx(\"span\",e({parentName:\"a\"},{className:\"icon icon-link\"}))),\"Sorting symbols to a unified format\"),mdx(\"p\",null,\"Sentry created a special tool to sort existing OS-provided symbol information into a unified format. This tool is called \",mdx(\"a\",e({parentName:\"p\"},{href:\"https://github.com/getsentry/symbolicator/tree/master/crates/symsorter\"}),\"symsorter\"),\". It is a Rust binary that can be compiled and run on your machine. \"),mdx(\"h4\",e({},{id:\"building-sorter\"}),mdx(\"a\",e({parentName:\"h4\"},{\"aria-hidden\":\"true\",tabIndex:-1,href:\"#building-sorter\"}),mdx(\"span\",e({parentName:\"a\"},{className:\"icon icon-link\"}))),\"Building Sorter\"),mdx(\"p\",null,\"You need to have Rust installed on your machine. You can install Rust using \",mdx(\"a\",e({parentName:\"p\"},{href:\"https://brew.sh\"}),\"homebrew\"),\":\"),mdx(\"pre\",e({},{className:\"language-bash\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-bash\"}),\"brew \",mdx(\"span\",e({parentName:\"code\"},{className:\"token function\"}),\"install\"),` rust\n`)),mdx(\"p\",null,\"Then you need to check out the symbolicator repository:\"),mdx(\"pre\",e({},{className:\"language-bash\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-bash\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"token function\"}),\"git\"),` clone git@github.com:getsentry/symbolicator.git\n`)),mdx(\"p\",null,\"Once you have Rust installed, you can build the symsorter binary by running the following command:\"),mdx(\"pre\",e({},{className:\"language-bash\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-bash\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"token builtin class-name\"}),\"cd\"),` symbolicator/crates/symsorter\ncargo build --release\n`)),mdx(\"p\",null,\"This will create a binary in \",mdx(\"inlineCode\",{parentName:\"p\"},\"symbolicator/target/release/symsorter\"),\". You can copy it to your path or run it from the current directory.\"),mdx(\"h3\",e({},{id:\"sorting\"}),mdx(\"a\",e({parentName:\"h3\"},{\"aria-hidden\":\"true\",tabIndex:-1,href:\"#sorting\"}),mdx(\"span\",e({parentName:\"a\"},{className:\"icon icon-link\"}))),\"Sorting\"),mdx(\"p\",null,\"In order to sort symbols, you need to create an empty folder on your local machine, for example \",mdx(\"inlineCode\",{parentName:\"p\"},\"~/ios_symbols\"),\".\"),mdx(\"p\",null,\"Then you need to run the following command:\"),mdx(\"pre\",e({},{className:\"language-bash\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-bash\"}),\"symbolicator/target/release/symsorter -zz -o ~/ios_symbols --prefix ios --bundle-id \",mdx(\"span\",e({parentName:\"code\"},{className:\"token number\"}),\"16.3\"),\".1-arm64e ~/Downloads/16.3.1\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"\\\\\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"\\\\\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"20D67\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"\\\\\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"\\\\\"),` arm64e\n`)),mdx(\"p\",null,\"You need to run it for every symbol file you have. In my case, I have a whopping 129 symbol files. I have created a bash script to run the command for every symbol file:\"),mdx(\"pre\",e({},{className:\"language-bash\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-bash\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"token shebang important\"}),\"#!/bin/bash\"),`\n\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token function\"}),\"find\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token builtin class-name\"}),\".\"),\" -type d -maxdepth \",mdx(\"span\",e({parentName:\"code\"},{className:\"token number\"}),\"1\"),\" -print0 \",mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\"|\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"while\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token builtin class-name\"}),\"read\"),\" -d $\",mdx(\"span\",e({parentName:\"code\"},{className:\"token string\"}),\"'\",mdx(\"span\",e({parentName:\"span\"},{className:\"token entity\",title:\"\\\\0\"}),\"\\\\0\"),\"'\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token function\"}),\"file\"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"do\"),`\n `,mdx(\"span\",e({parentName:\"code\"},{className:\"token builtin class-name\"}),\"echo\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token string\"}),'\"Processing ',mdx(\"span\",e({parentName:\"span\"},{className:\"token variable\"}),\"$file\"),'\"'),`\n `,mdx(\"span\",e({parentName:\"code\"},{className:\"token assign-left variable\"}),\"path\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\"=\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token variable\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token variable\"}),\"`\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token builtin class-name\"}),\"echo\"),\" $file \",mdx(\"span\",e({parentName:\"span\"},{className:\"token operator\"}),\"|\"),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"token function\"}),\"sed\"),\" -E \",mdx(\"span\",e({parentName:\"span\"},{className:\"token string\"}),\"'s/^\\\\.\\\\/([0-9\\\\.]*) \\\\(([A-Z0-9]*)\\\\) ?(arm64.)?/\",mdx(\"span\",e({parentName:\"span\"},{className:\"token entity\",title:\"\\\\1\"}),\"\\\\1\"),\"-\",mdx(\"span\",e({parentName:\"span\"},{className:\"token entity\",title:\"\\\\2\"}),\"\\\\2\"),\"-\",mdx(\"span\",e({parentName:\"span\"},{className:\"token entity\",title:\"\\\\3\"}),\"\\\\3\"),\"/'\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token variable\"}),\"`\")),`\n `,mdx(\"span\",e({parentName:\"code\"},{className:\"token builtin class-name\"}),\"echo\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token string\"}),'\"path: ',mdx(\"span\",e({parentName:\"span\"},{className:\"token variable\"}),\"$path\"),'\"'),`\n\n `,mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"..\"),\"/symbolicator/target/release/symsorter -zz -o \",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"..\"),\"/sorted_symbols --prefix ios --bundle-id \",mdx(\"span\",e({parentName:\"code\"},{className:\"token string\"}),'\"',mdx(\"span\",e({parentName:\"span\"},{className:\"token variable\"}),\"$path\"),'\"'),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token string\"}),'\"',mdx(\"span\",e({parentName:\"span\"},{className:\"token variable\"}),\"$file\"),'\"'),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"done\"),`\n`)),mdx(\"p\",null,\"You run this script in the folder where you have extracted the system frameworks. It will create a folder called \",mdx(\"inlineCode\",{parentName:\"p\"},\"sorted_symbols\"),\" with the sorted symbols. This would take a while, and your CPU would do Brrr.\"),mdx(Image,{alt:\"CPU load using symbolicator: Brrrr\",src:\"/images/sentry-symbols/brrr.png\",width:269,height:467,priority:!0,mdxType:\"Image\"}),mdx(\"h3\",e({},{id:\"uploading-symbols-to-s3\"}),mdx(\"a\",e({parentName:\"h3\"},{\"aria-hidden\":\"true\",tabIndex:-1,href:\"#uploading-symbols-to-s3\"}),mdx(\"span\",e({parentName:\"a\"},{className:\"icon icon-link\"}))),\"Uploading symbols to S3\"),mdx(\"p\",null,\"As mentioned above, you need to provide an S3 bucket to host the sorted symbols. You can create an S3 bucket using the AWS console.\"),mdx(\"p\",null,\"Then you need to upload the sorted symbols to the S3 bucket. You can use the AWS console or the AWS CLI. I have used the AWS CLI to upload the symbols:\"),mdx(\"pre\",e({},{className:\"language-bash\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-bash\"}),\"aws s3 \",mdx(\"span\",e({parentName:\"code\"},{className:\"token function\"}),\"sync\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"..\"),`/sorted_symbols s3://sentry-symbols/\n`)),mdx(\"h3\",e({},{id:\"configuring-sentry-to-use-the-symbols\"}),mdx(\"a\",e({parentName:\"h3\"},{\"aria-hidden\":\"true\",tabIndex:-1,href:\"#configuring-sentry-to-use-the-symbols\"}),mdx(\"span\",e({parentName:\"a\"},{className:\"icon icon-link\"}))),\"Configuring Sentry to use the symbols\"),mdx(\"p\",null,\"In order to configure yout Sentry instance to use the symbols you need to open your project preferences (open your project -\u003e Cogwheel on the right) and go to the Processing -\u003e Debug Files section.\"),mdx(\"p\",null,'Then in Custom repositories select \"Add Repository\" and enter the needed information:'),mdx(Image,{alt:\"Configuration\",src:\"/images/sentry-symbols/configuration.png\",width:1354,height:2010,priority:!0,mdxType:\"Image\"}),mdx(\"h2\",e({},{id:\"conclusion\"}),mdx(\"a\",e({parentName:\"h2\"},{\"aria-hidden\":\"true\",tabIndex:-1,href:\"#conclusion\"}),mdx(\"span\",e({parentName:\"a\"},{className:\"icon icon-link\"}))),\"Conclusion\"),mdx(Image,{alt:\"Voila\",src:\"/images/sentry-symbols/voila.png\",width:1346,height:244,priority:!0,mdxType:\"Image\"}),mdx(\"p\",null,\"Nice, now you can see the method names of the system frameworks in your stack traces. This is a great step towards better crash reports. \"),mdx(\"p\",null,\"NB: As Apple is going to release new iOS versions going forward, there would be a need to add new symbols to the S3 bucket. I am not sure how to automate this process, but I am sure it is possible. Most of the time it would be possible to collect the new symbols by updating your phone to the latest iOS version and connecting it to Xcode.\"),mdx(\"p\",null,\"I hope this article was helpful. If you have any questions, feel free to reach out to me on Twitter: \",mdx(\"a\",e({parentName:\"p\"},{href:\"https://twitter.com/gk0io\"}),\"@gk0io\"),\".\"))}MDXContent.isMDXComponent=!0;\n","scope":{"title":"Self-Hosted Sentry: iOS system frames de-symbolication","description":"How to set up self-hosted Sentry for system frames de-symbolication on iOS.","date":"2023-04-03","image":"/images/sentry-symbols/sentry.svg","published":true}},"frontMatter":{"title":"Self-Hosted Sentry: iOS system frames de-symbolication","description":"How to set up self-hosted Sentry for system frames de-symbolication on iOS.","date":"2023-04-03","image":"/images/sentry-symbols/sentry.svg","published":true}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"self-hosted-sentry-smybols"},"buildId":"JzhBuRdGGKtUlqmGbVtnu","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>